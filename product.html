<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MED&გზური — სამედიცინო ძიება</title>
    <meta name="description" content="სამედიცინო კვლევების ძიება, სიმპტომების ნავიგაცია და კლინიკების მოძიება">

    <!-- Open Graph -->
    <meta property="og:title" content="MED&გზური — სამედიცინო ძიება">
    <meta property="og:description" content="სამედიცინო კვლევების ძიება, სიმპტომების ნავიგაცია და კლინიკების მოძიება">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ka_GE">
    <meta name="twitter:card" content="summary">

    <!-- Performance: DNS prefetch & preconnect -->
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.2/html2pdf.bundle.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.9/purify.min.js" defer></script>

    <!-- PWA manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0A1628">

    <style>
        :root {
            --teal: #5FA8D3;
            --teal-hover: #4A8FB8;
            --teal-light: rgba(95, 168, 211, 0.08);
            --teal-pale: rgba(95, 168, 211, 0.15);
            --navy: #0A1628;
            --navy-soft: #1A2A42;
            --text: #0A1628;
            --text-secondary: rgba(10, 22, 40, 0.6);
            --text-muted: rgba(10, 22, 40, 0.4);
            --bg: #FAFBFC;
            --white: #FFFFFF;
            --border: #E2E8EA;
            --border-light: #F0F2F4;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --shadow-sm: 0 1px 3px rgba(10, 22, 40, 0.06);
            --shadow-md: 0 4px 12px rgba(10, 22, 40, 0.08);
            --shadow-lg: 0 8px 30px rgba(10, 22, 40, 0.12);
            --shadow-xl: 0 20px 50px rgba(10, 22, 40, 0.15);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Noto Sans Georgian', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text);
            background: var(--bg);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ═══════════════ NAVBAR ═══════════════ */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 0.875rem 1.5rem;
        }

        .navbar-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            text-decoration: none;
            color: var(--text);
            font-weight: 700;
            font-size: 1.125rem;
        }

        .logo svg {
            width: 28px;
            height: 28px;
            color: var(--teal);
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-link {
            padding: 0.5rem 0.875rem;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .nav-link:hover { color: var(--teal); background: var(--teal-light); }

        .nav-btn {
            padding: 0.5rem 1rem;
            font-size: 0.8125rem;
            font-weight: 600;
            color: white;
            background: var(--teal);
            border: none;
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .nav-btn:hover { background: var(--teal-hover); transform: translateY(-1px); }

        /* ═══════════════ HERO ═══════════════ */
        .hero {
            padding: 3rem 1.5rem 2rem;
            text-align: center;
            max-width: 720px;
            margin: 0 auto;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.875rem;
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--teal);
            background: var(--teal-light);
            border: 1px solid var(--teal-pale);
            border-radius: 999px;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .hero-badge .dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .hero h1 {
            font-size: clamp(1.75rem, 4vw, 2.5rem);
            font-weight: 800;
            line-height: 1.25;
            letter-spacing: -0.02em;
            margin-bottom: 0.75rem;
        }

        .hero h1 .highlight { color: var(--teal); }

        .hero p {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* ═══════════════ TABS ═══════════════ */
        .search-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 1.5rem 3rem;
        }

        .tabs {
            display: flex;
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 0.375rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
            gap: 0.25rem;
        }

        .tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.25s;
        }

        .tab:hover { color: var(--text); background: var(--bg); }

        .tab.active {
            color: white;
            background: var(--navy);
            box-shadow: var(--shadow-md);
        }

        .tab svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .tab-label-full { display: inline; }
        .tab-label-short { display: none; }

        @media (max-width: 640px) {
            .tab-label-full { display: none; }
            .tab-label-short { display: inline; }
            .tab { font-size: 0.75rem; padding: 0.625rem 0.5rem; }
        }

        /* ═══════════════ SEARCH PANELS ═══════════════ */
        .panel {
            display: none;
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .panel.active { display: block; }

        .panel-header {
            padding: 1.5rem 1.5rem 0;
        }

        .panel-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .panel-desc {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .panel-body {
            padding: 0 1.5rem 1.5rem;
        }

        /* ═══════════════ FORM ELEMENTS ═══════════════ */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.375rem;
        }

        .form-hint {
            font-size: 0.6875rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-family: inherit;
            color: var(--text);
            background: var(--bg);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            transition: all 0.2s;
            outline: none;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            border-color: var(--teal);
            background: var(--white);
            box-shadow: 0 0 0 3px rgba(95, 168, 211, 0.12);
        }

        .form-input::placeholder,
        .form-textarea::placeholder {
            color: var(--text-muted);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 640px) {
            .form-row { grid-template-columns: 1fr; }
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.375rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            background: var(--bg);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .checkbox-item:hover { border-color: var(--teal); color: var(--text); }

        .checkbox-item.checked {
            background: var(--teal-light);
            border-color: var(--teal);
            color: var(--teal);
        }

        .checkbox-item input { display: none; }

        /* ═══════════════ SUBMIT BUTTON ═══════════════ */
        .submit-section {
            padding: 1.25rem 1.5rem;
            background: var(--bg);
            border-top: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .submit-info {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .submit-info svg {
            width: 14px;
            height: 14px;
            display: inline-block;
            vertical-align: -2px;
            margin-right: 2px;
        }

        .btn-search {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 700;
            font-family: inherit;
            color: white;
            background: linear-gradient(135deg, var(--teal), var(--teal-hover));
            border: none;
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(95, 168, 211, 0.3);
        }

        .btn-search:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(95, 168, 211, 0.4);
        }

        .btn-search:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-search svg { width: 18px; height: 18px; }

        .btn-search .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ═══════════════ RESULTS ═══════════════ */
        .results-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 1.5rem 4rem;
            display: none;
        }

        .results-container.visible { display: block; }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.25rem;
        }

        .results-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .results-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .result-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .result-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--teal-pale);
        }

        .result-card-header {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .result-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            background: var(--teal-light);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .result-icon svg {
            width: 20px;
            height: 20px;
        }

        .result-info {
            flex: 1;
            min-width: 0;
        }

        .result-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            line-height: 1.3;
        }

        .result-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .result-source {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .result-source svg { width: 12px; height: 12px; }

        .result-body {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }

        .result-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-bottom: 0.75rem;
        }

        .result-tag {
            display: inline-block;
            font-size: 0.6875rem;
            font-weight: 600;
            padding: 0.1875rem 0.5rem;
            background: rgba(95, 168, 211, 0.08);
            color: #5FA8D3;
            border-radius: 999px;
        }

        .result-card-title {
            font-size: 1rem;
            font-weight: 700;
            line-height: 1.3;
            color: var(--text);
        }

        .result-card-body {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .result-card-body p {
            margin-bottom: 0.5rem;
        }

        .result-card-source {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        .result-link {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--teal);
            text-decoration: none;
            margin-top: 0.75rem;
            transition: color 0.2s;
        }

        .result-link:hover {
            color: var(--teal-hover);
        }

        .result-section {
            margin-bottom: 1.5rem;
        }

        .result-section-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-light);
        }

        .result-section-icon {
            font-size: 1.25rem;
        }

        .result-section-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text);
        }

        .tag-pill {
            font-size: 0.6875rem;
            font-weight: 600;
            padding: 0.1875rem 0.5rem;
            background: var(--teal-light);
            color: var(--teal);
            border-radius: 999px;
        }

        .result-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .btn-visit {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.875rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--teal);
            background: var(--teal-light);
            border: 1px solid var(--teal-pale);
            border-radius: 999px;
            text-decoration: none;
            transition: all 0.2s;
        }

        .btn-visit:hover {
            background: var(--teal);
            color: white;
            border-color: var(--teal);
        }

        .btn-visit svg { width: 12px; height: 12px; }

        /* ═══════════════ PRIORITY BADGES ═══════════════ */
        .priority-badge {
            font-size: 0.625rem;
            font-weight: 700;
            padding: 0.125rem 0.5rem;
            border-radius: 999px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .priority-high {
            background: rgba(239, 68, 68, 0.1);
            color: #DC2626;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .priority-med {
            background: rgba(245, 158, 11, 0.1);
            color: #D97706;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .priority-low {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        /* ═══════════════ LOADING ═══════════════ */
        .loading {
            display: none;
            text-align: center;
            padding: 3rem 0;
        }

        .loading.visible { display: block; }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--teal);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        .loading-steps {
            max-width: 320px;
            margin: 0 auto;
        }

        .loading-step {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-light);
        }

        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--teal-light);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .step-icon svg { width: 12px; height: 12px; color: var(--teal); }

        .loading-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 1rem;
        }

        /* ═══════════════ ERROR & EMPTY ═══════════════ */
        .error-state, .empty-state {
            text-align: center;
            padding: 3rem 0;
            display: none;
        }

        .error-state.visible, .empty-state.visible { display: block; }

        .state-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
        }

        .error-state .state-icon { background: rgba(239, 68, 68, 0.1); }
        .empty-state .state-icon { background: var(--teal-light); }

        .state-icon svg {
            width: 28px;
            height: 28px;
        }

        .error-state .state-icon svg { color: var(--danger); }
        .empty-state .state-icon svg { color: var(--teal); }

        .state-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .state-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .btn-retry {
            padding: 0.5rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--teal);
            background: var(--teal-light);
            border: 1px solid var(--teal-pale);
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-retry:hover { background: var(--teal); color: white; }

        /* ═══════════════ FOOTER ═══════════════ */
        .disclaimer {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem 1.5rem 2rem;
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.7;
        }

        /* ═══════════════ AI PROCESSING ═══════════════ */
        .ai-processing {
            display: none;
            text-align: center;
            padding: 3rem 1.5rem;
            max-width: 500px;
            margin: 0 auto;
        }

        .ai-processing.visible {
            display: block;
        }

        .ai-orb {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--teal), var(--teal-hover));
            margin: 0 auto 1.5rem;
            animation: orbPulse 2s ease-in-out infinite;
            box-shadow: 0 0 30px rgba(95, 168, 211, 0.3);
        }

        @keyframes orbPulse {
            0%, 100% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        .ai-status {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.375rem;
        }

        .ai-substatus {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .ai-steps {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .ai-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8125rem;
            color: var(--text-muted);
            transition: all 0.3s;
        }

        .ai-step.active {
            color: var(--teal);
            font-weight: 600;
        }

        .ai-step.done {
            color: var(--success);
        }

        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s;
        }

        .ai-step.active .step-dot {
            background: var(--teal);
            box-shadow: 0 0 8px rgba(95, 168, 211, 0.4);
            animation: dotPulse 1s infinite;
        }

        .ai-step.done .step-dot {
            background: var(--success);
        }

        @keyframes dotPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.4); }
        }

        /* ═══════════════ ERROR MESSAGE ═══════════════ */
        .error-message {
            display: none;
            padding: 0.75rem 1.25rem;
            margin: 0.75rem 1.5rem;
            font-size: 0.8125rem;
            color: #DC2626;
            background: rgba(239, 68, 68, 0.06);
            border: 1px solid rgba(239, 68, 68, 0.15);
            border-radius: var(--radius-md);
        }

        .error-message.visible {
            display: block;
        }

        /* ═══════════════ PRIORITY BADGES (enhanced) ═══════════════ */
        .priority-high {
            background: rgba(239, 68, 68, 0.1);
            color: #DC2626;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .priority-medium {
            background: rgba(245, 158, 11, 0.1);
            color: #D97706;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .priority-low {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .result-rating {
            display: inline-flex;
            gap: 2px;
            margin-top: 0.375rem;
            font-size: 0.75rem;
            color: var(--warning);
        }

        .phase-badge {
            display: inline-flex;
            padding: 0.1875rem 0.5rem;
            font-size: 0.625rem;
            font-weight: 700;
            background: var(--navy);
            color: white;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .comparison-table-wrapper {
            overflow-x: auto;
            margin: 1rem 0;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8125rem;
        }

        .comparison-table th {
            padding: 0.75rem 1rem;
            background: var(--navy);
            color: white;
            font-weight: 600;
            text-align: left;
            white-space: nowrap;
        }

        .comparison-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-light);
        }

        .comparison-table tr:nth-child(even) td {
            background: var(--bg);
        }

        .comparison-table tr:hover td {
            background: var(--teal-light);
        }

        .next-steps {
            background: linear-gradient(135deg, var(--teal-light), rgba(95, 168, 211, 0.04));
            border: 1px solid var(--teal-pale);
            border-radius: var(--radius-lg);
            padding: 1.25rem 1.5rem;
            margin-top: 1.5rem;
        }

        .next-steps-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--navy);
        }

        .next-step-item {
            display: flex;
            align-items: flex-start;
            gap: 0.625rem;
            padding: 0.5rem 0;
            font-size: 0.8125rem;
            color: var(--text);
            line-height: 1.5;
        }

        .next-step-icon {
            font-size: 1.125rem;
            flex-shrink: 0;
            margin-top: 0.0625rem;
        }

        .tips-section {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.25rem 1.5rem;
            margin-top: 1rem;
        }

        .tips-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        .tip-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.375rem 0;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .result-disclaimer {
            margin-top: 1.5rem;
            padding: 1rem 1.25rem;
            background: rgba(245, 158, 11, 0.06);
            border: 1px solid rgba(245, 158, 11, 0.15);
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.7;
            text-align: center;
        }

        .result-price {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            background: rgba(16, 185, 129, 0.08);
            border: 1px solid rgba(16, 185, 129, 0.2);
            color: #059669;
            font-weight: 600;
            font-size: 0.75rem;
            border-radius: 999px;
            margin-top: 0.5rem;
        }

        /* ═══════════════ DOWNLOAD BUTTON ═══════════════ */
        .download-report-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            background: var(--teal);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-family: 'Noto Sans Georgian', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-left: auto;
        }
        .download-report-btn:hover { background: var(--teal-hover); }
        .download-report-btn:disabled {
            opacity: 0.6;
            cursor: wait;
        }
        .results-header {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        /* ═══════════════ PDF REPORT STYLES ═══════════════ */
        .report-page {
            font-family: 'Noto Sans Georgian', sans-serif;
            width: 760px;
            padding: 40px;
            color: #1a1a1a;
            line-height: 1.8;
            background: #fff;
            box-sizing: border-box;
        }
        .report-header-block {
            text-align: center;
            border-bottom: 2px solid #5FA8D3;
            padding-bottom: 12pt;
            margin-bottom: 16pt;
        }
        .report-logo {
            font-size: 10pt;
            color: #5FA8D3;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .report-title {
            font-size: 16pt;
            color: #1e293b;
            margin: 8pt 0 4pt;
            font-weight: 700;
        }
        .report-date {
            font-size: 9pt;
            color: #6b7280;
        }
        .report-section-heading {
            font-size: 13pt;
            font-weight: 700;
            color: #1e293b;
            margin: 18pt 0 8pt;
            padding-bottom: 4pt;
            border-bottom: 1px solid #e5e7eb;
        }
        .report-body p {
            text-align: justify;
            margin: 0 0 8pt;
            font-size: 10.5pt;
        }
        .report-disclaimer {
            font-size: 8pt;
            color: #6b7280;
            border-top: 1px solid #e5e7eb;
            padding-top: 8pt;
            margin-top: 20pt;
            font-style: italic;
        }
        .report-footer {
            text-align: center;
            font-size: 7pt;
            color: #9ca3af;
            margin-top: 12pt;
        }

        /* ═══════════════ CHATBOT WIDGET ═══════════════ */
        #chatbot-widget {
            position: fixed;
            bottom: 0;
            right: 0;
            z-index: 9999;
            font-family: 'Noto Sans Georgian', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .chatbot-toggle {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--teal), var(--teal-hover));
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(95, 168, 211, 0.4);
            transition: all 0.3s;
            z-index: 10000;
        }

        .chatbot-toggle:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 28px rgba(95, 168, 211, 0.5);
        }

        .chatbot-toggle.hidden { display: none; }

        .chatbot-toggle svg {
            width: 24px;
            height: 24px;
        }

        .chatbot-toggle-pulse {
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            background: rgba(95, 168, 211, 0.3);
            animation: chatPulse 2s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes chatPulse {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.2); opacity: 0; }
        }

        .chatbot-notification {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 20px;
            height: 20px;
            background: #EF4444;
            color: white;
            font-size: 0.6875rem;
            font-weight: 700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        .chatbot-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 370px;
            max-height: 520px;
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: 0 12px 48px rgba(10, 22, 40, 0.18);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: scale(0.8) translateY(20px);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 10001;
        }

        .chatbot-container.open {
            transform: scale(1) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .chatbot-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            background: var(--navy);
            color: white;
        }

        .chatbot-avatar {
            width: 36px;
            height: 36px;
            background: rgba(95, 168, 211, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .chatbot-avatar svg {
            width: 20px;
            height: 20px;
            color: var(--teal);
        }

        .chatbot-info { flex: 1; }

        .chatbot-name {
            font-size: 0.875rem;
            font-weight: 700;
        }

        .chatbot-status {
            font-size: 0.6875rem;
            opacity: 0.8;
        }

        .chatbot-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 0;
            line-height: 1;
        }

        .chatbot-close:hover { opacity: 1; }

        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-height: 280px;
            max-height: 320px;
            background: var(--bg);
        }

        .message {
            display: flex;
            gap: 0.5rem;
            max-width: 88%;
            animation: msgIn 0.3s ease;
        }

        @keyframes msgIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-bot { align-self: flex-start; }

        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--teal-light);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .message-avatar svg {
            width: 14px;
            height: 14px;
            color: var(--teal);
        }

        .message-content {
            padding: 0.625rem 0.875rem;
            border-radius: 14px;
            font-size: 0.8125rem;
            line-height: 1.55;
            word-break: break-word;
        }

        .message-user .message-content {
            background: var(--teal);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-bot .message-content {
            background: var(--white);
            color: var(--text);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        .message-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.875rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 999px;
            text-decoration: none;
            transition: all 0.2s;
            border: 1px solid var(--border);
        }

        .action-whatsapp {
            background: #25D366;
            color: white;
            border-color: #25D366;
        }

        .action-whatsapp:hover {
            background: #1eb954;
        }

        .action-form {
            background: var(--white);
            color: var(--teal);
            border-color: var(--teal-pale);
        }

        .action-form:hover {
            background: var(--teal-light);
        }

        .typing-dots {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 0.75rem 1rem;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 14px;
            border-bottom-left-radius: 4px;
        }

        .typing-dots span {
            width: 7px;
            height: 7px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typingBounce 1.2s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-5px); opacity: 1; }
        }

        .chatbot-quick-replies {
            display: flex;
            gap: 0.375rem;
            padding: 0.5rem 1rem;
            flex-wrap: wrap;
            background: var(--white);
            border-top: 1px solid var(--border-light);
        }

        .quick-reply {
            padding: 0.375rem 0.75rem;
            font-size: 0.6875rem;
            font-weight: 600;
            font-family: inherit;
            color: var(--teal);
            background: var(--teal-light);
            border: 1px solid var(--teal-pale);
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-reply:hover {
            background: var(--teal);
            color: white;
        }

        .chatbot-input-area {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--white);
            border-top: 1px solid var(--border);
        }

        .chatbot-input {
            flex: 1;
            padding: 0.625rem 0.875rem;
            font-size: 0.8125rem;
            font-family: inherit;
            color: var(--text);
            background: var(--bg);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            outline: none;
            transition: border-color 0.2s;
        }

        .chatbot-input:focus {
            border-color: var(--teal);
        }

        .chatbot-input::placeholder {
            color: var(--text-muted);
        }

        .chatbot-send {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--teal);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .chatbot-send:hover {
            background: var(--teal-hover);
            transform: scale(1.05);
        }

        .chatbot-send svg {
            width: 16px;
            height: 16px;
        }

        @media (max-width: 480px) {
            .chatbot-container {
                bottom: 0;
                right: 0;
                left: 0;
                width: 100%;
                max-height: 85vh;
                border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            }

            .chatbot-toggle {
                bottom: 1rem;
                right: 1rem;
            }
        }
    </style>
</head>
<body>

    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="navbar-inner">
            <a href="/" class="logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                </svg>
                MED&გზური
            </a>
            <div class="nav-links">
                <a href="/" class="nav-link">მთავარი</a>
                <a href="/product" class="nav-link" style="color: var(--teal);">ძიება</a>
                <a href="/login" class="nav-btn">შესვლა</a>
            </div>
        </div>
    </nav>

    <!-- HERO -->
    <section class="hero">
        <div class="hero-badge">
            <span class="dot"></span>
            ძიება აქტიურია
        </div>
        <h1>სამედიცინო <span class="highlight">კვლევები</span> ერთი ნაბიჯით</h1>
        <p>ატვირთეთ დიაგნოზი ან აღწერეთ სიმპტომები. ჩვენი სისტემა მოიძიებს შესაბამის კვლევებს, კლინიკებს და მკურნალობის ვარიანტებს მთელი მსოფლიოდან.</p>
    </section>

    <!-- SEARCH TABS -->
    <div class="search-container">
        <div class="tabs" role="tablist" aria-label="ძიების ტიპები">
            <button class="tab active" data-tab="research" onclick="switchTab('research')" role="tab" aria-selected="true" aria-controls="panel-research" id="tab-research">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                <span class="tab-label-full">კვლევების ძიება</span>
                <span class="tab-label-short">კვლევა</span>
            </button>
            <button class="tab" data-tab="symptoms" onclick="switchTab('symptoms')" role="tab" aria-selected="false" aria-controls="panel-symptoms" id="tab-symptoms">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                <span class="tab-label-full">სიმპტომების ნავიგაცია</span>
                <span class="tab-label-short">სიმპტომები</span>
            </button>
            <button class="tab" data-tab="clinics" onclick="switchTab('clinics')" role="tab" aria-selected="false" aria-controls="panel-clinics" id="tab-clinics">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M3 21h18"/><path d="M9 8h1"/><path d="M9 12h1"/><path d="M9 16h1"/><path d="M14 8h1"/><path d="M14 12h1"/><path d="M14 16h1"/><path d="M5 21V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16"/></svg>
                <span class="tab-label-full">კლინიკების ძიება</span>
                <span class="tab-label-short">კლინიკა</span>
            </button>
        </div>

        <!-- ═══════ PANEL 1: RESEARCH SEARCH ═══════ -->
        <div class="panel active" id="panel-research" role="tabpanel" aria-labelledby="tab-research">
            <div class="panel-header">
                <div class="panel-title">კვლევების ძიება</div>
                <div class="panel-desc">ჩაწერეთ დიაგნოზი ან სამედიცინო მდგომარეობა. სისტემა მოიძიებს უახლეს კვლევებს საერთაშორისო სამედიცინო ბაზებიდან.</div>
            </div>
            <div class="panel-body">
                <div class="form-group">
                    <label class="form-label">დიაგნოზი ან სამედიცინო მდგომარეობა <span class="form-hint">(ქართულად ან ინგლისურად)</span></label>
                    <input type="text" class="form-input" id="research-diagnosis" maxlength="500" placeholder="მაგ: ჰიპოქსიურ-იშემიური ენცეფალოპათია, ტიპი 2 დიაბეტი, ფილტვის კიბო...">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ასაკობრივი ჯგუფი</label>
                        <select class="form-select" id="research-age">
                            <option value="">არჩევა (არასავალდებულო)</option>
                            <option value="neonate">ახალშობილი (0-28 დღე)</option>
                            <option value="infant">ჩვილი (1-12 თვე)</option>
                            <option value="child">ბავშვი (1-12 წელი)</option>
                            <option value="adolescent">მოზარდი (13-17 წელი)</option>
                            <option value="adult">ზრდასრული (18-64)</option>
                            <option value="elderly">ხანდაზმული (65+)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">კვლევის ტიპი</label>
                        <select class="form-select" id="research-type">
                            <option value="all">ყველა ტიპი</option>
                            <option value="clinical_trial">კლინიკური კვლევა</option>
                            <option value="systematic_review">სისტემატური მიმოხილვა</option>
                            <option value="case_study">შემთხვევის კვლევა</option>
                            <option value="meta_analysis">ერთობლივი ანალიზი</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">დამატებითი კონტექსტი <span class="form-hint">(არასავალდებულო)</span></label>
                    <textarea class="form-textarea" id="research-context" maxlength="2000" placeholder="აღწერეთ დამატებითი დეტალები: რა მკურნალობა იყო ცდილი, რა შედეგი გამოიღო, კონკრეტული ინტერესის სფერო..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ძიების გეოგრაფია</label>
                    <div class="checkbox-group" id="research-regions">
                        <label class="checkbox-item checked" onclick="toggleCheck(this)">
                            <input type="checkbox" value="global" checked> მთელი მსოფლიო
                        </label>
                        <label class="checkbox-item" onclick="toggleCheck(this)">
                            <input type="checkbox" value="eu"> ევროკავშირი
                        </label>
                        <label class="checkbox-item" onclick="toggleCheck(this)">
                            <input type="checkbox" value="us"> აშშ
                        </label>
                        <label class="checkbox-item" onclick="toggleCheck(this)">
                            <input type="checkbox" value="turkey"> თურქეთი
                        </label>
                        <label class="checkbox-item" onclick="toggleCheck(this)">
                            <input type="checkbox" value="israel"> ისრაელი
                        </label>
                    </div>
                </div>
            </div>
            <div class="submit-section">
                <div class="submit-info">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    თქვენი მონაცემები დაცულია და არ ინახება
                </div>
                <button class="btn-search" onclick="startSearch('research')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                    ძიების დაწყება
                </button>
            </div>
            <div class="error-message" id="error-research"></div>
        </div>

        <!-- ═══════ PANEL 2: SYMPTOM NAVIGATION ═══════ -->
        <div class="panel" id="panel-symptoms" role="tabpanel" aria-labelledby="tab-symptoms">
            <div class="panel-header">
                <div class="panel-title">სიმპტომების ნავიგაცია</div>
                <div class="panel-desc">აღწერეთ სიმპტომები. სისტემა შემოგთავაზებთ რა გამოკვლევების ჩატარება შეიძლება იყოს მიზანშეწონილი და სად.</div>
            </div>
            <div class="panel-body">
                <div class="form-group">
                    <label class="form-label">სიმპტომების აღწერა</label>
                    <textarea class="form-textarea" id="symptoms-text" maxlength="2000" placeholder="დეტალურად აღწერეთ სიმპტომები: რა გაწუხებთ, რამდენ ხანს, რამე ამწვავებს თუ ამსუბუქებს..." style="min-height: 150px;"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ასაკი</label>
                        <input type="number" class="form-input" id="symptoms-age" placeholder="მაგ: 45">
                    </div>
                    <div class="form-group">
                        <label class="form-label">სქესი</label>
                        <select class="form-select" id="symptoms-sex">
                            <option value="">არჩევა</option>
                            <option value="male">მამრობითი</option>
                            <option value="female">მდედრობითი</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">არსებული დიაგნოზები <span class="form-hint">(არასავალდებულო)</span></label>
                    <input type="text" class="form-input" id="symptoms-existing" maxlength="500" placeholder="მაგ: დიაბეტი, ჰიპერტენზია...">
                </div>
                <div class="form-group">
                    <label class="form-label">მიმდინარე მედიკამენტები <span class="form-hint">(არასავალდებულო)</span></label>
                    <input type="text" class="form-input" id="symptoms-meds" maxlength="500" placeholder="მაგ: მეტფორმინი 500მგ, ამლოდიპინი 5მგ...">
                </div>
            </div>
            <div class="submit-section">
                <div class="submit-info">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    ეს არ არის დიაგნოზი — მხოლოდ საინფორმაციო მიმოხილვა
                </div>
                <button class="btn-search" onclick="startSearch('symptoms')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                    ანალიზის დაწყება
                </button>
            </div>
            <div class="error-message" id="error-symptoms"></div>
        </div>

        <!-- ═══════ PANEL 3: CLINIC SEARCH ═══════ -->
        <div class="panel" id="panel-clinics" role="tabpanel" aria-labelledby="tab-clinics">
            <div class="panel-header">
                <div class="panel-title">კლინიკების ძიება</div>
                <div class="panel-desc">მიუთითეთ დიაგნოზი და სასურველი ქვეყანა. სისტემა მოიძიებს შესაბამის კლინიკებს, ტექნოლოგიებს და სავარაუდო ფასებს.</div>
            </div>
            <div class="panel-body">
                <div class="form-group">
                    <label class="form-label">დიაგნოზი ან საჭირო მკურნალობა</label>
                    <input type="text" class="form-input" id="clinics-diagnosis" maxlength="500" placeholder="მაგ: თავის ტვინის სიმსივნე, მუხლის ენდოპროთეზირება, IVF...">
                </div>
                <div class="form-group">
                    <label class="form-label">სასურველი ქვეყნები</label>
                    <div class="checkbox-group" id="clinics-countries">
                        <label class="checkbox-item" onclick="toggleCheck(this)">
                            <input type="checkbox" value="germany"> გერმანია
                        </label>
                        <label class="checkbox-item" onclick="toggleCheck(this)">
                            <input type="checkbox" value="turkey"> თურქეთი
                        </label>
                        <label class="checkbox-item" onclick="toggleCheck(this)">
                            <input type="checkbox" value="israel"> ისრაელი
                        </label>
                        <label class="checkbox-item" onclick="toggleCheck(this)">
                            <input type="checkbox" value="usa"> აშშ
                        </label>
                        <label class="checkbox-item" onclick="toggleCheck(this)">
                            <input type="checkbox" value="spain"> ესპანეთი
                        </label>
                        <label class="checkbox-item" onclick="toggleCheck(this)">
                            <input type="checkbox" value="india"> იაპაზონი
                        </label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ბიუჯეტის დიაპაზონი</label>
                        <select class="form-select" id="clinics-budget">
                            <option value="">არ მაქვს პრეფერენცია</option>
                            <option value="low">5,000€-მდე</option>
                            <option value="mid">5,000€ - 20,000€</option>
                            <option value="high">20,000€ - 50,000€</option>
                            <option value="premium">50,000€+</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ენის პრეფერენცია</label>
                        <select class="form-select" id="clinics-language">
                            <option value="any">ნებისმიერი</option>
                            <option value="english">ინგლისური</option>
                            <option value="russian">რუსული</option>
                            <option value="turkish">თურქული</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">დამატებითი მოთხოვნები <span class="form-hint">(არასავალდებულო)</span></label>
                    <textarea class="form-textarea" id="clinics-notes" maxlength="1000" placeholder="მაგ: გჭირდებათ თარჯიმანი, გსურთ ონლაინ კონსულტაცია ჯერ, გსურთ ბავშვებისთვის სპეციალიზებული კლინიკა..." style="min-height: 80px;"></textarea>
                </div>
            </div>
            <div class="submit-section">
                <div class="submit-info">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    ფასები ინფორმაციული ხასიათისაა და შეიძლება განსხვავდებოდეს
                </div>
                <button class="btn-search" onclick="startSearch('clinics')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                    კლინიკების ძიება
                </button>
            </div>
            <div class="error-message" id="error-clinics"></div>
        </div>
    </div>

    <!-- AI PROCESSING -->
    <div class="ai-processing" id="ai-processing">
        <div class="ai-orb"></div>
        <div class="ai-status" id="ai-status">ანალიზი მიმდინარეობს...</div>
        <div class="ai-substatus" id="ai-substatus">გთხოვთ დაელოდოთ, ეს შეიძლება რამდენიმე წუთი გასტანოს</div>
        <div class="ai-steps" id="ai-steps">
            <div class="ai-step active" data-step="search">
                <span class="step-dot"></span>
                მოძიება
            </div>
            <div class="ai-step" data-step="analyze">
                <span class="step-dot"></span>
                ანალიზი
            </div>
            <div class="ai-step" data-step="validate">
                <span class="step-dot"></span>
                ვალიდაცია
            </div>
            <div class="ai-step" data-step="format">
                <span class="step-dot"></span>
                ფორმატირება
            </div>
        </div>
    </div>

    <!-- RESULTS -->
    <div class="results-container" id="results-container">
        <div class="results-header">
            <div class="results-title" id="results-title">ძიების შედეგები</div>
            <div class="results-meta" id="results-meta"></div>
            <button id="download-report-btn" class="download-report-btn" onclick="downloadReport()" style="display:none">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                ანგარიშის ჩამოტვირთვა (PDF)
            </button>
        </div>
        <div id="results-list"></div>
    </div>

    <!-- PDF REPORT TEMPLATE (hidden via overflow, not offscreen — html2canvas compatible) -->
    <div id="report-template" style="overflow:hidden;height:0;width:0;position:absolute;left:0;top:0;opacity:0;pointer-events:none;">
        <div class="report-page" id="report-page">
            <div class="report-header-block">
                <div class="report-logo">MED&გზური</div>
                <h1 class="report-title" id="report-title-text"></h1>
                <div class="report-date" id="report-date-text"></div>
            </div>
            <div class="report-body" id="report-body-content"></div>
            <div class="report-disclaimer" id="report-disclaimer-text"></div>
            <div class="report-footer">
                MED&გზური &copy; 2026 | ეს ანგარიში არ ჩაანაცვლებს ექიმის კონსულტაციას
            </div>
        </div>
    </div>

    <!-- DISCLAIMER -->
    <div class="disclaimer">
        <p>⚕️ მედგზური არ ანაცვლებს ექიმის კონსულტაციას. წარმოდგენილი ინფორმაცია განკუთვნილია საინფორმაციო მიზნებისთვის. ნებისმიერი სამედიცინო გადაწყვეტილება უნდა მიიღოთ კვალიფიციურ სპეციალისტთან კონსულტაციის შემდეგ.</p>
    </div>

    <script>
    // ═══════════════ STATE ═══════════════
    /** @type {string} Currently active search tab */
    let currentTab = 'research';
    /** @type {boolean} Whether a search is in progress (prevents concurrent searches) */
    let isSearching = false;
    /** @type {object|null} Last search result (used for PDF report generation) */
    let lastSearchResult = null;
    /** @type {string|null} Last search type (research|symptoms|clinics) */
    let lastSearchType = null;
    /** @type {string|null} Last search query (original user input) */
    let lastSearchQuery = null;

    // ═══════════════ TAB SWITCHING ═══════════════
    /**
     * Switch the active search tab and panel.
     * Blocked while a search is in progress to prevent state corruption.
     *
     * @param {string} tab - Target tab name (research|symptoms|clinics)
     */
    function switchTab(tab) {
        if (isSearching) return;
        currentTab = tab;

        document.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('active');
            t.setAttribute('aria-selected', 'false');
        });
        const activeTab = document.querySelector(`[data-tab="${tab}"]`);
        activeTab.classList.add('active');
        activeTab.setAttribute('aria-selected', 'true');

        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(`panel-${tab}`).classList.add('active');

        // Hide results when switching
        document.getElementById('results-container').classList.remove('visible');
        document.getElementById('ai-processing').classList.remove('visible');
    }

    // ═══════════════ CHECKBOX TOGGLE ═══════════════
    /**
     * Toggle a custom checkbox element's checked state.
     * @param {HTMLElement} el - The .checkbox-item container element
     */
    function toggleCheck(el) {
        const input = el.querySelector('input');
        input.checked = !input.checked;
        el.classList.toggle('checked', input.checked);
    }

    // ═══════════════ SEARCH LOGIC ═══════════════
    /**
     * Execute a search: validate input → show progress → call API → display results.
     *
     * Uses an AbortController with a 120-second timeout. Progress is visualized
     * through a multi-step animation. On failure, shows a Georgian error message.
     *
     * @param {string} type - Search type (research|symptoms|clinics)
     */
    async function startSearch(type) {
        if (isSearching) return;

        // Collect form data
        const data = collectFormData(type);
        if (!data) return;

        // Save original query for report generation
        lastSearchQuery = data.diagnosis || data.symptoms || data.treatment || '';

        isSearching = true;
        const btn = document.querySelector(`#panel-${type} .btn-search`);
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div> მიმდინარეობს...';

        // Hide previous results, show processing
        document.getElementById('results-container').classList.remove('visible');
        document.getElementById('ai-processing').classList.add('visible');
        document.getElementById('ai-processing').style.display = 'block';

        // Build dynamic AI steps based on search type
        buildAISteps(type);
        resetAISteps();

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000);

        try {
            const steps = getTeamSteps(type);

            // Step 1
            updateAIStep(steps[0].key, 'active');
            updateAIStatus(steps[0].label + '...', 'ვეძებთ რელევანტურ ინფორმაციას მრავალ წყაროში');

            const response = await fetch('/api/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, data }),
                signal: controller.signal
            });
            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }

            updateAIStep(steps[0].key, 'done');

            // Step 2
            updateAIStep(steps[1].key, 'active');
            updateAIStatus(steps[1].label + '...', 'სისტემა ამუშავებს მოძიებულ მონაცემებს');
            await delay(800);
            updateAIStep(steps[1].key, 'done');

            // Step 3
            updateAIStep(steps[2].key, 'active');
            updateAIStatus(steps[2].label + '...', 'წყაროების სიზუსტე მოწმდება');
            await delay(600);
            updateAIStep(steps[2].key, 'done');

            // Step 4
            updateAIStep(steps[3].key, 'active');
            updateAIStatus(steps[3].label + '...', 'შედეგები სტრუქტურდება ქართულ ენაზე');
            await delay(400);
            updateAIStep(steps[3].key, 'done');

            const result = await response.json();

            // Display results
            displayResults(type, result);

        } catch (err) {
            clearTimeout(timeoutId);
            if (err.name === 'AbortError') {
                showError(type, 'ძიებას ძალიან დიდი დრო დასჭირდა. გთხოვთ სცადოთ თავიდან.');
            } else {
                console.error('Search error:', err);
                showError(type, 'ძიება ვერ შესრულდა. გთხოვთ სცადოთ თავიდან.');
            }
        } finally {
            isSearching = false;
            btn.disabled = false;
            btn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                ${type === 'symptoms' ? 'ანალიზის დაწყება' : type === 'clinics' ? 'კლინიკების ძიება' : 'ძიების დაწყება'}
            `;
            document.getElementById('ai-processing').style.display = 'none';
        }
    }

    /**
     * Collect and validate form data for the given search type.
     *
     * Returns null (and shows an error) if validation fails.
     * Validates: required fields, max text lengths, age range.
     *
     * @param {string} type - Search type
     * @returns {object|null} Form data object or null on validation failure
     */
    function collectFormData(type) {
        const errEl = document.getElementById(`error-${type}`);
        errEl.classList.remove('visible');

        if (type === 'research') {
            const diagnosis = document.getElementById('research-diagnosis').value.trim();
            if (!diagnosis) {
                showError(type, 'გთხოვთ მიუთითოთ დიაგნოზი ან სამედიცინო მდგომარეობა.');
                return null;
            }
            if (diagnosis.length > 500) {
                showError(type, 'დიაგნოზი არ უნდა აღემატებოდეს 500 სიმბოლოს.');
                return null;
            }
            const context = document.getElementById('research-context').value.trim();
            if (context.length > 2000) {
                showError(type, 'კონტექსტი არ უნდა აღემატებოდეს 2000 სიმბოლოს.');
                return null;
            }
            const regions = [...document.querySelectorAll('#research-regions input:checked')].map(i => i.value);
            return {
                diagnosis,
                ageGroup: document.getElementById('research-age').value,
                researchType: document.getElementById('research-type').value,
                context,
                regions
            };
        }

        if (type === 'symptoms') {
            const symptoms = document.getElementById('symptoms-text').value.trim();
            if (!symptoms) {
                showError(type, 'გთხოვთ აღწეროთ სიმპტომები.');
                return null;
            }
            if (symptoms.length > 2000) {
                showError(type, 'სიმპტომების აღწერა არ უნდა აღემატებოდეს 2000 სიმბოლოს.');
                return null;
            }
            const age = document.getElementById('symptoms-age').value;
            if (age && (isNaN(age) || age < 0 || age > 150)) {
                showError(type, 'გთხოვთ მიუთითოთ სწორი ასაკი.');
                return null;
            }
            return {
                symptoms,
                age,
                sex: document.getElementById('symptoms-sex').value,
                existingConditions: document.getElementById('symptoms-existing').value.trim(),
                medications: document.getElementById('symptoms-meds').value.trim()
            };
        }

        if (type === 'clinics') {
            const diagnosis = document.getElementById('clinics-diagnosis').value.trim();
            if (!diagnosis) {
                showError(type, 'გთხოვთ მიუთითოთ დიაგნოზი ან საჭირო მკურნალობა.');
                return null;
            }
            if (diagnosis.length > 500) {
                showError(type, 'ტექსტი არ უნდა აღემატებოდეს 500 სიმბოლოს.');
                return null;
            }
            const notes = document.getElementById('clinics-notes').value.trim();
            if (notes.length > 1000) {
                showError(type, 'შენიშვნა არ უნდა აღემატებოდეს 1000 სიმბოლოს.');
                return null;
            }
            const countries = [...document.querySelectorAll('#clinics-countries input:checked')].map(i => i.value);
            return {
                diagnosis,
                countries,
                budget: document.getElementById('clinics-budget').value,
                language: document.getElementById('clinics-language').value,
                notes
            };
        }
    }

    // ═══════════════ AI STEP ANIMATIONS ═══════════════
    function getTeamSteps(type) {
        const steps = {
            research: [
                { key: 'step1', label: 'PubMed ძიება' },
                { key: 'step2', label: 'კლინიკური კვლევები' },
                { key: 'step3', label: 'მკურნალობის ანალიზი' },
                { key: 'step4', label: 'ანგარიშის შექმნა' }
            ],
            symptoms: [
                { key: 'step1', label: 'სიმპტომების შეფასება' },
                { key: 'step2', label: 'გამოკვლევების შერჩევა' },
                { key: 'step3', label: 'სპეციალისტების შეფასება' },
                { key: 'step4', label: 'ანგარიშის შექმნა' }
            ],
            clinics: [
                { key: 'step1', label: 'კლინიკების ძიება' },
                { key: 'step2', label: 'ფასების ანალიზი' },
                { key: 'step3', label: 'შეფასებების შეკრება' },
                { key: 'step4', label: 'ანგარიშის შექმნა' }
            ]
        };
        return steps[type] || steps.research;
    }

    function buildAISteps(type) {
        const container = document.getElementById('ai-steps');
        const steps = getTeamSteps(type);
        container.innerHTML = steps.map(s => `
            <div class="ai-step" data-step="${s.key}">
                <span class="step-dot"></span>
                ${escapeHtml(s.label)}
            </div>
        `).join('');
    }

    function resetAISteps() {
        document.querySelectorAll('.ai-step').forEach(s => {
            s.classList.remove('active', 'done');
        });
    }

    function updateAIStep(step, state) {
        const el = document.querySelector(`.ai-step[data-step="${step}"]`);
        if (el) {
            el.classList.remove('active', 'done');
            el.classList.add(state);
        }
    }

    function updateAIStatus(main, sub) {
        document.getElementById('ai-status').textContent = main;
        document.getElementById('ai-substatus').textContent = sub;
    }

    function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

    // ═══════════════ DISPLAY RESULTS ═══════════════
    /**
     * Render search results into the results container.
     *
     * Handles multiple response formats:
     *   - sections[] (enhanced n8n response)
     *   - items[] (standard flat format)
     *   - summary (text-only fallback)
     *   - comparison, tips, nextSteps (supplementary data)
     *
     * Saves the result for later PDF report generation.
     *
     * @param {string} type   - Search type (for icon/title selection)
     * @param {object} result - API response object
     */
    function displayResults(type, result) {
        const container = document.getElementById('results-container');
        const list = document.getElementById('results-list');
        const title = document.getElementById('results-title');
        const meta = document.getElementById('results-meta');

        const titles = {
            research: 'კვლევების შედეგები',
            symptoms: 'სიმპტომების ანალიზი',
            clinics: 'ნაპოვნი კლინიკები'
        };

        title.textContent = titles[type] || 'შედეგები';
        meta.textContent = result.meta || '';
        list.innerHTML = '';

        // Demo mode banner
        if (result.isDemo) {
            list.innerHTML += '<div class="result-card" style="background:rgba(245,158,11,0.08);border-color:rgba(245,158,11,0.3)"><div class="result-card-body" style="color:#92400e;text-align:center;font-weight:600">&#9888;&#65039; ეს სადემონსტრაციო მონაცემებია. რეალური შედეგები მალე ხელმისაწვდომი იქნება.</div></div>';
        }

        // Render sections if available (enhanced n8n response)
        if (result.sections && result.sections.length > 0) {
            result.sections.forEach(function(section) {
                list.appendChild(renderSection(section, type));
            });
        }
        // Fallback: render old-format items
        else if (result.items && result.items.length > 0) {
            result.items.forEach(function(item) {
                list.appendChild(renderResultCard(item, type));
            });
        }
        else if (result.summary) {
            var card = document.createElement('div');
            card.className = 'result-card';
            card.innerHTML = '<div class="result-card-body">' + formatResultBody(result.summary) + '</div>';
            list.appendChild(card);
        }

        // Comparison table (clinic reports)
        if (result.comparison) {
            list.appendChild(renderComparisonTable(result.comparison));
        }

        // Tips section
        if (result.tips && result.tips.length > 0) {
            list.appendChild(renderTips(result.tips));
        }

        // Next steps
        if (result.nextSteps && result.nextSteps.length > 0) {
            list.appendChild(renderNextSteps(result.nextSteps));
        }

        // Disclaimer from API
        if (result.disclaimer) {
            var disc = document.createElement('div');
            disc.className = 'result-disclaimer';
            disc.textContent = result.disclaimer;
            list.appendChild(disc);
        }

        // Save result for report generation
        lastSearchResult = result;
        lastSearchResult.originalQuery = lastSearchQuery;
        lastSearchType = type;

        // Show download button
        var dlBtn = document.getElementById('download-report-btn');
        if (dlBtn) dlBtn.style.display = 'inline-flex';

        container.classList.add('visible');
        container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function renderSection(section, type) {
        var div = document.createElement('div');
        div.className = 'result-section';
        div.innerHTML = '<div class="result-section-header">' +
            '<span class="result-section-icon">' + (section.icon || '') + '</span>' +
            '<span class="result-section-title">' + escapeHtml(section.title) + '</span>' +
            '</div>';

        if (section.type === 'text' && section.items) {
            section.items.forEach(function(item) {
                var card = document.createElement('div');
                card.className = 'result-card';
                card.innerHTML = (item.title ? '<div class="result-card-title" style="margin-bottom:0.5rem">' + escapeHtml(item.title) + '</div>' : '') +
                    '<div class="result-card-body">' + formatResultBody(item.body) + '</div>';
                div.appendChild(card);
            });
        } else if (section.items) {
            section.items.forEach(function(item) {
                div.appendChild(renderResultCard(item, type));
            });
        }

        return div;
    }

    function renderResultCard(item, type) {
        var card = document.createElement('div');
        card.className = 'result-card';

        var priorityHtml = '';
        if (item.priority) {
            var priorityLabels = {
                high: '\uD83D\uDD34 მაღალი პრიორიტეტი',
                medium: '\uD83D\uDFE1 საშუალო პრიორიტეტი',
                low: '\uD83D\uDFE2 დაბალი პრიორიტეტი'
            };
            priorityHtml = '<span class="priority-badge priority-' + item.priority + '">' + (priorityLabels[item.priority] || '') + '</span>';
        }

        var ratingHtml = '';
        if (item.rating) {
            var fullStars = Math.floor(item.rating);
            ratingHtml = '<div class="result-rating">' + '\u2B50'.repeat(fullStars) + ' ' + item.rating + '/5</div>';
        }

        var phaseHtml = '';
        if (item.phase) {
            phaseHtml = '<span class="phase-badge">' + escapeHtml(item.phase) + ' \u10E4\u10D0\u10D6\u10D0</span>';
        }

        var priceHtml = '';
        if (item.price) {
            priceHtml = '<div class="result-price">\uD83D\uDCB0 ' + escapeHtml(item.price) + '</div>';
        }

        card.innerHTML = priorityHtml +
            '<div class="result-card-header">' +
                '<div class="result-icon">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' + getResultIcon(type) + '</svg>' +
                '</div>' +
                '<div>' +
                    '<div class="result-card-title">' + escapeHtml(item.title) + '</div>' +
                    (item.source ? '<div class="result-card-source">' + escapeHtml(item.source) + '</div>' : '') +
                '</div>' +
            '</div>' +
            '<div class="result-card-body">' + formatResultBody(item.body) + '</div>' +
            ratingHtml +
            phaseHtml +
            priceHtml +
            (item.tags ? '<div class="result-tags">' + item.tags.map(function(t) { return '<span class="result-tag">' + escapeHtml(t) + '</span>'; }).join('') + '</div>' : '') +
            (item.url ? '<a href="' + escapeHtml(item.url) + '" target="_blank" rel="noopener" class="result-link">\u10EC\u10E7\u10D0\u10E0\u10DD\u10E1 \u10DC\u10D0\u10EE\u10D5\u10D0 \u2192</a>' : '');

        return card;
    }

    function renderComparisonTable(comparison) {
        var wrapper = document.createElement('div');
        wrapper.className = 'comparison-table-wrapper';
        var html = '<table class="comparison-table"><thead><tr>';
        comparison.headers.forEach(function(h) {
            html += '<th>' + escapeHtml(h) + '</th>';
        });
        html += '</tr></thead><tbody>';
        comparison.rows.forEach(function(row) {
            html += '<tr>';
            row.forEach(function(cell) {
                html += '<td>' + escapeHtml(cell) + '</td>';
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        wrapper.innerHTML = html;
        return wrapper;
    }

    function renderNextSteps(nextSteps) {
        var div = document.createElement('div');
        div.className = 'next-steps';
        div.innerHTML = '<div class="next-steps-title">\uD83D\uDCCC \u10E8\u10D4\u10DB\u10D3\u10D4\u10D2\u10D8 \u10DC\u10D0\u10D1\u10D8\u10EF\u10D4\u10D1\u10D8</div>' +
            nextSteps.map(function(step) {
                return '<div class="next-step-item">' +
                    '<span class="next-step-icon">' + (step.icon || '\u27A1\uFE0F') + '</span>' +
                    '<span>' + escapeHtml(step.text) + '</span>' +
                '</div>';
            }).join('');
        return div;
    }

    function renderTips(tips) {
        var div = document.createElement('div');
        div.className = 'tips-section';
        div.innerHTML = '<div class="tips-title">\uD83D\uDCA1 \u10DE\u10E0\u10D0\u10E5\u10E2\u10D8\u10D9\u10E3\u10DA\u10D8 \u10E0\u10E9\u10D4\u10D5\u10D4\u10D1\u10D8</div>' +
            tips.map(function(tip) {
                return '<div class="tip-item">' +
                    '<span>' + (tip.icon || '\uD83D\uDCA1') + '</span>' +
                    '<span>' + escapeHtml(tip.text) + '</span>' +
                '</div>';
            }).join('');
        return div;
    }

    function getResultIcon(type) {
        const icons = {
            research: '<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>',
            symptoms: '<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>',
            clinics: '<path d="M3 21h18"/><path d="M5 21V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16"/><path d="M9 8h1"/><path d="M9 12h1"/><path d="M14 8h1"/><path d="M14 12h1"/>'
        };
        return icons[type] || icons.research;
    }

    /**
     * Convert markdown text to sanitized HTML for result card bodies.
     *
     * Uses marked.js for parsing and DOMPurify for XSS prevention.
     * Falls back to plain-text paragraph wrapping if libraries are unavailable.
     *
     * Performance fix: marked.setOptions() was called on every invocation,
     * re-configuring the parser each time. Now configured once via an IIFE flag.
     *
     * @param {string} text - Markdown or plain text
     * @returns {string} Sanitized HTML
     */
    let _markedConfigured = false;
    const _purifyConfig = {
        ALLOWED_TAGS: ['p', 'br', 'strong', 'b', 'em', 'i', 'ul', 'ol', 'li', 'h3', 'h4', 'a', 'code', 'pre', 'blockquote', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'hr', 'sup', 'sub'],
        ALLOWED_ATTR: ['href', 'target', 'rel']
    };

    function formatResultBody(text) {
        if (!text) return '';
        if (typeof marked !== 'undefined') {
            try {
                // Configure marked once — avoids per-call overhead
                if (!_markedConfigured) {
                    marked.setOptions({ breaks: true, gfm: true, headerIds: false, mangle: false });
                    _markedConfigured = true;
                }
                const rawHtml = marked.parse(text);
                if (typeof DOMPurify !== 'undefined') {
                    return DOMPurify.sanitize(rawHtml, _purifyConfig);
                }
                return rawHtml;
            } catch (e) {
                console.warn('[MedGzuri] Markdown parse failed, falling back:', e.message);
            }
        }
        // Fallback: plain text with paragraph wrapping
        return text
            .split('\n')
            .filter(l => l.trim())
            .map(l => `<p>${escapeHtml(l)}</p>`)
            .join('');
    }

    // ═══════════════ PDF REPORT GENERATION ═══════════════
    /**
     * Generate and download a PDF report from the last search results.
     *
     * Flow:
     *   1. Request structured report from /api/search (type: 'report')
     *   2. Fallback to buildLocalReport() if API fails
     *   3. Render HTML into a hidden container
     *   4. Convert to PDF using html2pdf.js
     *   5. Clean up temporary DOM elements
     */
    async function downloadReport() {
        if (!lastSearchResult) return;

        var btn = document.getElementById('download-report-btn');
        btn.disabled = true;
        btn.textContent = 'ანგარიში მზადდება...';

        var pdfContainer = null;

        try {
            // Request report from API
            var report;
            try {
                var response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'report',
                        data: {
                            reportType: lastSearchType,
                            searchResult: lastSearchResult
                        }
                    })
                });

                if (response.ok) {
                    report = await response.json();
                }
            } catch (fetchErr) {
                console.warn('[MedGzuri] Report API failed, using local:', fetchErr.message);
            }

            // Fallback: build report from existing results
            if (!report || (!report.sections && !report.summary)) {
                report = buildLocalReport(lastSearchType, lastSearchResult);
            }

            // Build date string
            var dateStr;
            try {
                dateStr = new Date().toLocaleDateString('ka-GE', { year: 'numeric', month: 'long', day: 'numeric' });
            } catch (e) {
                dateStr = new Date().toISOString().slice(0, 10);
            }

            // Build body HTML from report
            var bodyHtml = '';
            if (report.sections && report.sections.length > 0) {
                report.sections.forEach(function(section) {
                    bodyHtml += '<div class="report-section-heading">' + escapeHtml(section.heading) + '</div>';
                    var paragraphs = (section.content || '').split('\n').filter(function(p) { return p.trim(); });
                    paragraphs.forEach(function(p) {
                        bodyHtml += '<p>' + escapeHtml(p) + '</p>';
                    });
                });
            } else if (report.summary) {
                bodyHtml = '<p>' + escapeHtml(report.summary) + '</p>';
            }

            // Fallback if body is still empty
            if (!bodyHtml) {
                report = buildLocalReport(lastSearchType, lastSearchResult);
                report.sections.forEach(function(section) {
                    bodyHtml += '<div class="report-section-heading">' + escapeHtml(section.heading) + '</div>';
                    var paragraphs = (section.content || '').split('\n').filter(function(p) { return p.trim(); });
                    paragraphs.forEach(function(p) {
                        bodyHtml += '<p>' + escapeHtml(p) + '</p>';
                    });
                });
            }

            // Create a standalone container for PDF rendering (avoids clipping issues)
            pdfContainer = document.createElement('div');
            pdfContainer.style.cssText = 'position:fixed;left:0;top:0;z-index:-1;opacity:0;pointer-events:none;background:#fff;';
            pdfContainer.innerHTML =
                '<div id="pdf-render-target" style="' +
                    'font-family:Noto Sans Georgian,sans-serif;' +
                    'width:700px;' +
                    'padding:40px 50px;' +
                    'color:#1a1a1a;' +
                    'line-height:1.8;' +
                    'background:#fff;' +
                    'box-sizing:border-box;' +
                '">' +
                    '<div style="text-align:center;border-bottom:2px solid #5FA8D3;padding-bottom:14px;margin-bottom:20px;">' +
                        '<div style="font-size:11pt;color:#5FA8D3;font-weight:700;letter-spacing:1px;">MED&amp;გზური</div>' +
                        '<h1 style="font-size:16pt;color:#1e293b;margin:10px 0 6px;font-weight:700;">' + escapeHtml(report.title || 'სამედიცინო ანგარიში') + '</h1>' +
                        '<div style="font-size:9pt;color:#6b7280;">' + escapeHtml(dateStr) + '</div>' +
                    '</div>' +
                    '<div class="report-body">' + bodyHtml + '</div>' +
                    '<div style="font-size:8pt;color:#6b7280;border-top:1px solid #e5e7eb;padding-top:10px;margin-top:24px;font-style:italic;">' +
                        escapeHtml(report.disclaimer || 'ეს ანგარიში არ ჩაანაცვლებს ექიმის კონსულტაციას.') +
                    '</div>' +
                    '<div style="text-align:center;font-size:7pt;color:#9ca3af;margin-top:14px;">' +
                        'MED&amp;გზური &copy; 2026 | ეს ანგარიში არ ჩაანაცვლებს ექიმის კონსულტაციას' +
                    '</div>' +
                '</div>';
            document.body.appendChild(pdfContainer);

            // Wait for browser to render
            await new Promise(function(resolve) { setTimeout(resolve, 300); });

            // Generate PDF from the standalone element
            var element = document.getElementById('pdf-render-target');
            var opt = {
                margin: [8, 5, 12, 5],
                filename: 'MedGzuri-' + (lastSearchType || 'report') + '-' + new Date().toISOString().slice(0, 10) + '.pdf',
                image: { type: 'jpeg', quality: 0.95 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    letterRendering: true,
                    scrollX: 0,
                    scrollY: 0,
                    x: 0,
                    y: 0,
                    width: 700,
                    windowWidth: 700
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['css', 'legacy'] }
            };

            // Wait for Georgian font to load before rendering
            if (document.fonts && document.fonts.ready) {
                await document.fonts.ready;
            }

            await html2pdf().set(opt).from(element).save();

        } catch (err) {
            console.error('[MedGzuri] Report download failed:', err);
            alert('ანგარიშის გენერაცია ვერ მოხერხდა. გთხოვთ სცადოთ თავიდან.');
        } finally {
            // Remove temporary container
            if (pdfContainer && pdfContainer.parentNode) {
                pdfContainer.parentNode.removeChild(pdfContainer);
            }
            btn.disabled = false;
            btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> ანგარიშის ჩამოტვირთვა (PDF)';
        }
    }

    function buildLocalReport(type, result) {
        var typeNames = { research: 'კვლევების', symptoms: 'სიმპტომების', clinics: 'კლინიკების' };
        var typeName = typeNames[type] || 'სამედიცინო';
        var query = result.originalQuery || lastSearchQuery || 'სამედიცინო მოთხოვნა';
        var sections = [];

        sections.push({
            heading: 'შესავალი',
            content: 'წინამდებარე ანგარიში მომზადებულია MED&გზურის სამედიცინო საძიებო სისტემის მიერ, თქვენი მოთხოვნის საფუძველზე: "' + query + '".\n\nანგარიშის მიზანია მოგაწოდოთ სისტემატიზებული ინფორმაცია თანამედროვე სამედიცინო კვლევებისა და კლინიკური პრაქტიკის შესახებ. ინფორმაცია მოძიებულია საერთაშორისო სამედიცინო მონაცემთა ბაზებიდან.\n\nგთხოვთ გაითვალისწინოთ, რომ ეს ანგარიში არ ჩაანაცვლებს კვალიფიციური ექიმის კონსულტაციას.'
        });

        // Extract content from sections format
        if (result.sections && result.sections.length > 0) {
            result.sections.forEach(function(section) {
                var content = '';
                if (section.items && section.items.length > 0) {
                    section.items.forEach(function(item, idx) {
                        content += (idx + 1) + '. ' + (item.title || 'მიგნება') + '\n';
                        content += (item.body || '') + '\n';
                        if (item.source) content += 'წყარო: ' + item.source + '\n';
                        if (item.tags && item.tags.length) content += 'თეგები: ' + item.tags.join(', ') + '\n';
                        content += '\n';
                    });
                }
                if (content.trim()) {
                    sections.push({
                        heading: section.title || 'მიგნებები',
                        content: content.trim()
                    });
                }
            });
        }
        // Fallback to items format
        else if (result.items && result.items.length > 0) {
            result.items.forEach(function(item, idx) {
                var itemContent = (item.body || '');
                if (item.source) itemContent += '\n\nწყარო: ' + item.source;
                if (item.tags && item.tags.length) itemContent += '\nთეგები: ' + item.tags.join(', ');
                if (item.price) itemContent += '\nსავარაუდო ღირებულება: ' + item.price;

                sections.push({
                    heading: item.title || ('მიგნება #' + (idx + 1)),
                    content: itemContent
                });
            });
        }

        if (result.summary) {
            sections.push({ heading: 'მიმოხილვა', content: result.summary });
        }

        // Add comparison if available
        if (result.comparison && result.comparison.headers && result.comparison.rows) {
            var compContent = result.comparison.headers.join(' | ') + '\n';
            compContent += result.comparison.rows.map(function(row) {
                return row.join(' | ');
            }).join('\n');
            sections.push({ heading: 'შედარებითი ანალიზი', content: compContent });
        }

        // Add next steps if available
        if (result.nextSteps && result.nextSteps.length > 0) {
            var stepsContent = result.nextSteps.map(function(step, i) {
                return (i + 1) + '. ' + step.text;
            }).join('\n');
            sections.push({ heading: 'რეკომენდებული შემდეგი ნაბიჯები', content: stepsContent });
        }

        // Add tips if available
        if (result.tips && result.tips.length > 0) {
            var tipsContent = result.tips.map(function(tip) {
                return '• ' + tip.text;
            }).join('\n');
            sections.push({ heading: 'პრაქტიკული რჩევები', content: tipsContent });
        }

        sections.push({
            heading: 'დასკვნა',
            content: 'ამ ანგარიშში წარმოდგენილი ინფორმაცია ეფუძნება საერთაშორისო სამედიცინო მონაცემთა ბაზებში არსებულ კვლევებსა და პუბლიკაციებს.\n\nმნიშვნელოვანია, რომ ყველა სამედიცინო გადაწყვეტილება მიღებული იყოს კვალიფიციურ სპეციალისტთან კონსულტაციის შემდეგ. ანგარიშში წარმოდგენილი ინფორმაცია დაგეხმარებათ ექიმთან უფრო ინფორმირებული საუბრის წარმართვაში.\n\nMED&გზური მზადაა გაგიწიოთ შემდგომი დახმარება — დამატებითი კვლევების მოძიება, კლინიკებთან კომუნიკაცია ან სამედიცინო დოკუმენტაციის თარგმანი.'
        });

        return {
            title: typeName + ' ანგარიში — ' + query,
            sections: sections,
            disclaimer: 'ეს ანგარიში არ ჩაანაცვლებს ექიმის კონსულტაციას. ყველა სამედიცინო გადაწყვეტილება უნდა მიიღოთ კვალიფიციურ სპეციალისტთან ერთად. MED&გზური არ არის სამედიცინო დაწესებულება და არ ახორციელებს დიაგნოსტიკურ ან სამკურნალო საქმიანობას.'
        };
    }

    /**
     * Escape HTML special characters to prevent XSS injection.
     *
     * Optimization: Uses a single regex pass with a replacement map instead of
     * 5 chained .replace() calls. Each .replace() creates a new string and
     * scans the full input — O(5n). Single-pass version is O(n).
     *
     * @param {string} str - Raw text to escape
     * @returns {string} HTML-safe string
     */
    const _escapeMap = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
    const _escapeRe = /[&<>"']/g;
    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(_escapeRe, ch => _escapeMap[ch]);
    }

    // ═══════════════ ERROR HANDLING ═══════════════
    /**
     * Display an error message for the given search panel.
     * @param {string} type - Search type (determines which error element to show)
     * @param {string} msg  - Georgian error message text
     */
    function showError(type, msg) {
        const el = document.getElementById(`error-${type}`);
        el.textContent = msg;
        el.classList.add('visible');
        el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // ═══════════════ TYPING PLACEHOLDER ANIMATION ═══════════════
    /**
     * Animated typewriter effect for input placeholders.
     *
     * Cycles through example phrases to guide users on what to search.
     * Pauses when the input is focused or has a value.
     *
     * Fix: Uses requestAnimationFrame-aware guards to prevent animation
     * from running on elements removed from the DOM (memory leak prevention).
     */
    (function() {
        const inputs = {
            'research-diagnosis': [
                'მაგ: ფილტვის კიბოს იმუნოთერაპია',
                'მაგ: ტიპი 2 დიაბეტის ახალი მკურნალობა',
                'მაგ: ჰიპოქსიურ-იშემიური ენცეფალოპათია',
                'მაგ: მულტიპლე სკლეროზის კვლევები'
            ],
            'symptoms-text': [
                'მაგ: თავის ტკივილი, გულისრევა, სახის დაბუჟება',
                'მაგ: ხანგრძლივი ხველა, წონაში კლება, ღამის ოფლიანობა',
                'მაგ: სახსრების ტკივილი, დილის შეშუპება, სიხისტე'
            ],
            'clinics-diagnosis': [
                'მაგ: თავის ტვინის სიმსივნე',
                'მაგ: მუხლის ენდოპროთეზირება',
                'მაგ: კარდიოქირურგია'
            ]
        };

        Object.entries(inputs).forEach(([id, phrases]) => {
            const el = document.getElementById(id);
            if (!el) return;
            let pi = 0, ci = 0, del = false;
            const origPlaceholder = el.placeholder;

            function animate() {
                // Guard: stop if element was removed from DOM (prevents memory leak)
                if (!el.isConnected) return;

                if (document.activeElement === el || el.value.length > 0) {
                    el.placeholder = origPlaceholder;
                    setTimeout(animate, 1000);
                    return;
                }
                const phrase = phrases[pi];
                if (!del) {
                    el.placeholder = phrase.substring(0, ci + 1);
                    ci++;
                    if (ci === phrase.length) { del = true; setTimeout(animate, 2500); return; }
                    setTimeout(animate, 55 + Math.random() * 30);
                } else {
                    el.placeholder = phrase.substring(0, ci - 1);
                    ci--;
                    if (ci === 0) { del = false; pi = (pi + 1) % phrases.length; setTimeout(animate, 300); return; }
                    setTimeout(animate, 25);
                }
            }
            setTimeout(animate, 1200 + Math.random() * 800);
        });
    })();
    </script>
    <script src="chatbot.js"></script>
</body>
</html>
